<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BellaBona IntelliRoute - Excel Master</title>

    <!-- External Utilities -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet">
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />

    <!-- Babel & React/Firebase from CDN -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        .map-dark-mode canvas {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .excel-grid th,
        .excel-grid td {
            border: 1px solid #334155;
            padding: 4px 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .excel-grid th {
            background: #1e293b;
            color: #94a3b8;
            font-weight: bold;
            text-align: left;
        }

        .excel-grid tr:hover {
            background: #1e293b;
        }

        .draggable-item {
            cursor: grab;
        }

        .draggable-item:active {
            cursor: grabbing;
            background: #3730a3;
        }
    </style>

    <!-- Error Handler -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            document.body.innerHTML = `
                <div style="background:#0f172a;color:#ef4444;padding:40px;font-family:monospace;height:100vh;display:flex;flex-col;justify-content:center;align-items:center;">
                    <div style="max-width:800px;">
                        <h1 style="font-size:24px;margin-bottom:20px;">SYSTEM CRITICAL ERROR</h1>
                        <p style="background:#1e293b;padding:20px;border-radius:10px;border:1px solid #334155;">${msg}</p>
                        <p style="color:#64748b;margin-top:10px;">${url}:${line}:${col}</p>
                    </div>
                </div>
            `;
            console.error("Critical Error:", error);
            return false;
        };
    </script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@google/generative-ai": "https://esm.sh/@google/generative-ai@0.21.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js",
        "maplibre-gl": "https://esm.sh/maplibre-gl@4.7.1"
      }
    }
    </script>

    <!-- INJECTED ORDERS DATA (from User Desktop) -->
    <script src="orders_data.js"></script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as firebaseApp from 'firebase/app';
        import {
            getFirestore,
            initializeFirestore,
            persistentLocalCache,
            persistentMultipleTabManager,
            collection,
            doc,
            setDoc,
            onSnapshot,
            writeBatch
        } from 'firebase/firestore';
        import { GoogleGenerativeAI } from '@google/generative-ai';
        import { Map as MapLibreMap, NavigationControl, AttributionControl, Marker, Popup, LngLatBounds } from 'maplibre-gl';

        console.log("App initializing...");

        // --- CONSTANTS ---
        const POTSDAM_KITCHEN = { lat: 52.3906, lng: 13.0645, address: "Friedrich-Engels-StraÃŸe 24, 14473 Potsdam" };

        const DRIVERS = [
            { id: 'samir', name: 'Samir', level: 1, capacity: 14, isActive: true, color: '#f59e0b' },
            { id: 'ali2', name: 'Ali 2', level: 1, capacity: 8, isActive: true, color: '#10b981' },
            { id: 'josef', name: 'Jozef', level: 3, capacity: 8, isActive: true, color: '#6366f1' },
            { id: 'ali1', name: 'Ali 1', level: 3, capacity: 8, isActive: true, color: '#ec4899' },
            { id: 'ankush', name: 'Ankush', level: 2, capacity: 14, isActive: true, color: '#3b82f6' },
            { id: 'harsh', name: 'Harsh', level: 4, capacity: 10, isActive: true, color: '#8b5cf6' },
            { id: 'packtor3', name: 'Packtor 3', level: 4, capacity: 7, isActive: true, color: '#cbd5e1' },
            { id: 'packator2', name: 'Packtor 2', level: 4, capacity: 7, isActive: true, color: '#94a3b8' },
            { id: 'packator1', name: 'Packtor 1', level: 4, capacity: 7, isActive: true, color: '#64748b' },
        ];

        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyBCljwsTQ-PHm20VP-i8VByNrRwVFgMl5I",
            authDomain: "routing-4aab8.firebaseapp.com",
            databaseURL: "https://routing-4aab8-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "routing-4aab8",
            storageBucket: "routing-4aab8.firebasestorage.app",
            messagingSenderId: "148497920348",
            appId: "1:148497920348:web:0e14c31aa4dfde00205199"
        };
        const app = firebaseApp.initializeApp(firebaseConfig);
        const db = initializeFirestore(app, {
            ignoreUndefinedProperties: true,
            localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() })
        });

        // --- COMPONENTS ---
        const RouteMap = ({ tours, onGeocodeUpdate }) => {
            const mapContainer = useRef(null);
            const map = useRef(null);
            const markersRef = useRef([]);
            const processingRef = useRef(new Set());

            useEffect(() => {
                if (map.current || !mapContainer.current) return;
                map.current = new MapLibreMap({
                    container: mapContainer.current,
                    style: 'https://tiles.openfreemap.org/styles/bright',
                    center: [13.405, 52.52],
                    zoom: 10,
                    attributionControl: false
                });
                map.current.addControl(new NavigationControl(), 'top-right');

                // Add Depot Marker
                new Marker({ color: '#ef4444', scale: 1.2 })
                    .setLngLat([POTSDAM_KITCHEN.lng, POTSDAM_KITCHEN.lat])
                    .setPopup(new Popup().setText("KITCHEN: " + POTSDAM_KITCHEN.address))
                    .addTo(map.current);

                return () => { map.current?.remove(); map.current = null; };
            }, []);

            useEffect(() => {
                // Geocoding Queue
                const queue = tours.flatMap(t => t.orders.filter(o => !o.lat && !processingRef.current.has(o.id)));
                if (queue.length === 0) return;

                const process = async () => {
                    const order = queue[0];
                    if (!order) return;
                    processingRef.current.add(order.id);

                    // Use Address first, then fallback to name
                    const query = order.address ? `${order.address}, Berlin, Germany` : `${order.name}, Berlin, Germany`;
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`, {
                            headers: { 'User-Agent': 'BellaBona-IntelliRoute/1.0' }
                        });
                        const data = await res.json();
                        if (data && data.length > 0) {
                            onGeocodeUpdate(order.id, parseFloat(data[0].lat), parseFloat(data[0].lon));
                        }
                    } catch (e) {
                        // console.error("Geocode failed", e);
                    }
                    setTimeout(process, 1200); // Rate limit
                };
                process();
            }, [tours]);

            useEffect(() => {
                if (!map.current) return;
                const m = map.current;
                markersRef.current.forEach(mk => mk.remove());
                markersRef.current = [];

                const features = [];
                const bounds = new LngLatBounds();
                bounds.extend([POTSDAM_KITCHEN.lng, POTSDAM_KITCHEN.lat]); // Include depot

                tours.forEach(tour => {
                    const driver = DRIVERS.find(d => d.id === tour.driverId);
                    const color = driver ? driver.color : '#cbd5e1';

                    // Route Line: Start at Depot -> Orders
                    const coords = [[POTSDAM_KITCHEN.lng, POTSDAM_KITCHEN.lat]];

                    tour.orders.forEach((o, idx) => {
                        if (o.lng && o.lat) {
                            coords.push([o.lng, o.lat]);
                            bounds.extend([o.lng, o.lat]);

                            // Marker
                            const el = document.createElement('div');
                            el.innerHTML = `<div style="background:${color};width:20px;height:20px;border-radius:50%;border:2px solid black;color:white;font-weight:bold;font-size:10px;display:flex;justify-content:center;align-items:center;">${idx + 1}</div>`;

                            const marker = new Marker({ element: el })
                                .setLngLat([o.lng, o.lat])
                                .setPopup(new Popup().setHTML(`<b>${o.name}</b><br>${o.address}`))
                                .addTo(m);
                            markersRef.current.push(marker);
                        }
                    });

                    if (coords.length > 1) {
                        features.push({
                            type: 'Feature',
                            properties: { color },
                            geometry: { type: 'LineString', coordinates: coords }
                        });
                    }
                });

                if (m.getSource('routes')) {
                    m.getSource('routes').setData({ type: 'FeatureCollection', features });
                } else if (m.isStyleLoaded()) {
                    m.addSource('routes', { type: 'geojson', data: { type: 'FeatureCollection', features } });
                    m.addLayer({ id: 'routes-line', type: 'line', source: 'routes', paint: { 'line-color': ['get', 'color'], 'line-width:': 4, 'line-opacity': 0.8 } });
                }

                if (!bounds.isEmpty()) m.fitBounds(bounds, { padding: 50 });
            }, [tours]);

            return <div ref={mapContainer} className="w-full h-full" />;
        };

        const ExcelView = ({ tours, setTours, unassigned }) => {
            const draggedItem = useRef(null);
            const draggedOverItem = useRef(null);

            const handleDragStart = (e, tourIdx, orderIdx) => {
                draggedItem.current = { tourIdx, orderIdx };
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragEnter = (e, tourIdx, orderIdx) => {
                draggedOverItem.current = { tourIdx, orderIdx };
            };

            const handleDrop = (e) => {
                const source = draggedItem.current;
                const dest = draggedOverItem.current;
                if (!source || !dest) return;
                if (source.tourIdx === dest.tourIdx && source.orderIdx === dest.orderIdx) return;

                const newTours = [...tours];
                const sourceTour = newTours[source.tourIdx];
                const destTour = newTours[dest.tourIdx];

                // Remove from source
                const [movedOrder] = sourceTour.orders.splice(source.orderIdx, 1);

                // Add to dest
                destTour.orders.splice(dest.orderIdx, 0, movedOrder);

                setTours(newTours);
                draggedItem.current = null;
                draggedOverItem.current = null;
            };

            return (
                <div className="overflow-x-auto bg-slate-900 border border-slate-700 rounded-lg shadow-xl">
                    <table className="w-full excel-grid text-left border-collapse">
                        <thead>
                            <tr>
                                <th style={{ width: '100px' }}>DRIVER</th>
                                <th style={{ width: '30px' }}>#</th>
                                <th style={{ width: '150px' }}>COMPANY</th>
                                <th style={{ width: '200px' }}>ADDRESS</th>
                                <th style={{ width: '50px' }}>BOX</th>
                                <th style={{ width: '80px' }}>TIME</th>
                                <th style={{ width: '60px' }}>POST</th>
                            </tr>
                        </thead>
                        <tbody>
                            {tours.map((tour, tIdx) => (
                                <React.Fragment key={tour.driverId}>
                                    {tour.orders.map((order, oIdx) => (
                                        <tr key={order.id}
                                            draggable
                                            onDragStart={(e) => handleDragStart(e, tIdx, oIdx)}
                                            onDragEnter={(e) => handleDragEnter(e, tIdx, oIdx)}
                                            onDragEnd={handleDrop}
                                            onDragOver={(e) => e.preventDefault()}
                                            className="draggable-item cursor-move"
                                        >
                                            {oIdx === 0 && (
                                                <td rowSpan={tour.orders.length} style={{ fontWeight: 900, color: DRIVERS.find(d => d.id === tour.driverId)?.color }}>
                                                    {tour.driverName.toUpperCase()}
                                                </td>
                                            )}
                                            <td className="text-center">{oIdx + 1}</td>
                                            <td className="font-bold">{order.name}</td>
                                            <td title={order.address}>{order.address}</td>
                                            <td className="text-center">{order.boxes}</td>
                                            <td>{order.deliverySlotStart} - {order.deliverySlotEnd}</td>
                                            <td>{order.postCode}</td>
                                        </tr>
                                    ))}
                                    {tour.orders.length === 0 && (
                                        <tr>
                                            <td style={{ fontWeight: 900, color: DRIVERS.find(d => d.id === tour.driverId)?.color }}>{tour.driverName.toUpperCase()}</td>
                                            <td colSpan="6" className="text-center italic opacity-50">No orders assigned</td>
                                        </tr>
                                    )}
                                </React.Fragment>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        function App() {
            const [tours, setTours] = useState([]);
            const [unassigned, setUnassigned] = useState([]);
            const [isCalculated, setIsCalculated] = useState(false);

            useEffect(() => {
                // Auto-calculate on load with injected data
                if (window.DEFAULT_ORDERS && !isCalculated) {
                    calculateInitialTours(window.DEFAULT_ORDERS);
                }
            }, []);

            const calculateInitialTours = (orders) => {
                // FORCE AVAILABLE: All drivers
                const activeDrivers = DRIVERS;

                // Simple Clustering Logic (Postcode/Area based)
                const newTours = activeDrivers.map(d => ({ driverId: d.id, driverName: d.name, orders: [] }));

                // Sort orders by postcode for basic clustering
                const sortedOrders = [...orders].sort((a, b) => a.postCode.localeCompare(b.postCode));

                // Distribute (Greedy Round Robin for now, optimized later)
                let driverIdx = 0;
                sortedOrders.forEach(order => {
                    // Try to find a driver with capacity
                    let assigned = false;
                    for (let i = 0; i < activeDrivers.length; i++) {
                        const d = activeDrivers[(driverIdx + i) % activeDrivers.length];
                        const tour = newTours.find(t => t.driverId === d.id);
                        if (tour.orders.length < d.capacity) {
                            tour.orders.push(order);
                            driverIdx = (driverIdx + i) % activeDrivers.length; // Stick to this driver for a bit
                            assigned = true;
                            break;
                        }
                    }
                    if (!assigned) {
                        // Unassigned
                    }
                });

                setTours(newTours);
                setIsCalculated(true);
            };

            const exportToCSV = () => {
                let csv = "Driver,Stop Number,Company,Address,Postal Code,Boxes\n";
                tours.forEach(t => {
                    t.orders.forEach((o, i) => {
                        csv += `${t.driverName},${i + 1},"${o.name}","${o.address}",${o.postCode},${o.boxes}\n`;
                    });
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `routing_schedule_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            return (
                <div className="h-screen flex flex-col">
                    <header className="bg-slate-900 border-b border-slate-700 h-14 flex items-center px-4 justify-between shrink-0">
                        <div className="flex items-center gap-4">
                            <h1 className="font-black text-lg tracking-tight">BELLA<span className="text-indigo-500">BONA</span> EXCEL MASTER</h1>
                            <span className="bg-emerald-500/10 text-emerald-500 text-[10px] font-bold px-2 py-1 rounded border border-emerald-500/20">ORDERS LOADED: {window.DEFAULT_ORDERS?.length || 0}</span>
                            <span className="bg-amber-500/10 text-amber-500 text-[10px] font-bold px-2 py-1 rounded border border-amber-500/20">DEPOT: POTSDAM</span>
                        </div>
                        <button onClick={exportToCSV} className="bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold px-4 py-2 rounded shadow-lg transition-all flex items-center gap-2">
                            <span>DOWNLOAD EXCEL / CSV</span>
                        </button>
                    </header>

                    <main className="flex-1 flex overflow-hidden">
                        {/* LEFT: EXCEL VIEW (Draggable) */}
                        <div className="w-1/2 flex flex-col border-r border-slate-700 bg-slate-800/50 p-4 overflow-y-auto">
                            <div className="mb-4 text-xs font-bold text-slate-400 uppercase tracking-widest flex justify-between">
                                <span>Interactive Schedule (Drag Rows to Reassign)</span>
                                <span>{tours.reduce((acc, t) => acc + t.orders.length, 0)} Assignments</span>
                            </div>
                            <ExcelView tours={tours} setTours={setTours} />
                        </div>

                        {/* RIGHT: MAP VIEW */}
                        <div className="w-1/2 relative bg-slate-950">
                            <RouteMap tours={tours} onGeocodeUpdate={(id, lat, lng) => {
                                setTours(prev => prev.map(t => ({
                                    ...t,
                                    orders: t.orders.map(o => o.id === id ? { ...o, lat, lng } : o)
                                })));
                            }} />
                            <div className="absolute top-4 right-4 bg-slate-900/90 p-4 rounded-xl border border-slate-700 text-xs backdrop-blur-md">
                                <h3 className="font-bold text-slate-300 mb-2">DRIVER LEGEND</h3>
                                <div className="space-y-1">
                                    {DRIVERS.map(d => (
                                        <div key={d.id} className="flex items-center gap-2">
                                            <div className="w-3 h-3 rounded-full" style={{ background: d.color }}></div>
                                            <span className="text-slate-400">{d.name} ({d.capacity} cap)</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>