<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BellaBona IntelliRoute - Excel Master</title>

    <!-- External Utilities -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet">
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />

    <!-- Babel & React/Firebase from CDN -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        .map-dark-mode canvas {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .excel-grid th,
        .excel-grid td {
            border: 1px solid #334155;
            padding: 4px 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .excel-grid th {
            background: #1e293b;
            color: #94a3b8;
            font-weight: bold;
            text-align: left;
        }

        .excel-grid tr:hover {
            background: #1e293b;
        }

        .draggable-item {
            cursor: grab;
        }

        .draggable-item:active {
            cursor: grabbing;
            background: #3730a3;
        }

        .grid-col-driver {
            min-width: 140px;
            border-right: 1px solid #334155;
        }
    </style>

    <!-- Error Handler -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            document.body.innerHTML = `
                <div style="background:#0f172a;color:#ef4444;padding:40px;font-family:monospace;height:100vh;display:flex;flex-col;justify-content:center;align-items:center;">
                    <div style="max-width:800px;">
                        <h1 style="font-size:24px;margin-bottom:20px;">SYSTEM CRITICAL ERROR</h1>
                        <p style="background:#1e293b;padding:20px;border-radius:10px;border:1px solid #334155;">${msg}</p>
                        <p style="color:#64748b;margin-top:10px;">${url}:${line}:${col}</p>
                    </div>
                </div>
            `;
            console.error("Critical Error:", error);
            return false;
        };
    </script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@google/generative-ai": "https://esm.sh/@google/generative-ai@0.21.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js",
        "maplibre-gl": "https://esm.sh/maplibre-gl@4.7.1"
      }
    }
    </script>

    <!-- INJECTED ORDERS DATA (from User Desktop) -->
    <script src="orders_data.js"></script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as firebaseApp from 'firebase/app';
        import {
            getFirestore,
            initializeFirestore,
            persistentLocalCache,
            persistentMultipleTabManager,
            collection,
            doc,
            setDoc,
            getDoc,
            onSnapshot,
            writeBatch
        } from 'firebase/firestore';
        import { GoogleGenerativeAI } from '@google/generative-ai';
        import { Map as MapLibreMap, NavigationControl, AttributionControl, Marker, Popup, LngLatBounds } from 'maplibre-gl';

        console.log("App initializing...");

        // --- CONSTANTS ---
        const POTSDAM_KITCHEN = { lat: 52.3906, lng: 13.0645, address: "Friedrich-Engels-StraÃŸe 24, 14473 Potsdam" };

        const DRIVERS = [
            { id: 'samir', name: 'Samir', level: 1, capacity: 16, isActive: true, color: '#f59e0b' },
            { id: 'ali1', name: 'Ali 1', level: 3, capacity: 12, isActive: true, color: '#ec4899' },
            { id: 'tasnim', name: 'Tasnim', level: 4, capacity: 16, isActive: true, color: '#d946ef' }, // Added Tasnim
            { id: 'packtor1', name: 'Packator 1', level: 4, capacity: 10, isActive: true, color: '#eab308' }, // Yellowish
            { id: 'ali2', name: 'Ali 2', level: 1, capacity: 10, isActive: true, color: '#f97316' }, // Orange
            { id: 'josef', name: 'Jozef', level: 3, capacity: 10, isActive: true, color: '#ef4444' }, // Red-Orange
            { id: 'packtor2', name: 'Packator 2', level: 4, capacity: 10, isActive: true, color: '#ffff00' }, // Bright Yellow
            { id: 'ali3', name: 'Ali 3', level: 2, capacity: 12, isActive: true, color: '#f59e0b' }, // Added Ali 3
        ];

        // --- GOLDEN PLAN (From Image) ---
        const GOLDEN_PLAN = {
            'samir': ['Ingenierburo', 'IngenieurbÃ¼ro', 'Shiftmove', 'Nike', 'King', 'Momox', 'Love', 'Lovehoney', 'Wohnung', 'Team Viewer', 'TeamViewer', 'IFX'],
            'ali1': ['Probio', 'Isi', 'Mektec', 'Pen', 'PenCef', 'Expert', 'Aignostic', 'Koppla'],
            'tasnim': ['Hilton', 'alteos', 'Ritual', 'teufel', 'Lautsprecher', 'Degewo-Kurfurstendam', 'Degewo-KurfÃ¼rstenstr', 'Kws', 'Almedia', 'Gsport-YUME', 'nexnet', 'unzer', 'Semrush', 'Adyen', 'Tui', 'Office'],
            'packtor1': ['Core', 'Affinidi', 'Bitpanda', 'Parloa', 'Personio', 'Verve'],
            'ali2': ['Getranke', 'GetrÃ¤nke', 'Joachim', 'Gottschalk', 'Liquid', 'Giantx', 'Heart', 'Berlin Heart', 'Tib', 'Omicron'],
            'josef': ['Viessmann', 'Digital', 'Pomelo', 'Gentlemates', 'Leapsome', 'Degewo-Brunnen', 'Bonial', 'Cognita', 'BCL', 'Charles'],
            'packtor2': ['Bahnhofstr', 'Kayak', 'Omio', 'Mehrower'],
            'ali3': ['Tam', 'Byrd', 'Taxfix', 'OnCloud', 'On Cloud', 'Beyvers', 'Ellabarowsky', 'Ella-Barowsky']
        };

        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyBCljwsTQ-PHm20VP-i8VByNrRwVFgMl5I",
            authDomain: "routing-4aab8.firebaseapp.com",
            databaseURL: "https://routing-4aab8-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "routing-4aab8",
            storageBucket: "routing-4aab8.firebasestorage.app",
            messagingSenderId: "148497920348",
            appId: "1:148497920348:web:0e14c31aa4dfde00205199"
        };
        const app = firebaseApp.initializeApp(firebaseConfig);
        const db = initializeFirestore(app, {
            ignoreUndefinedProperties: true,
            localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() })
        });

        // --- COMPONENTS ---
        const RouteMap = ({ tours, onGeocodeUpdate, height }) => {
            const mapContainer = useRef(null);
            const map = useRef(null);
            const markersRef = useRef([]);
            const processingRef = useRef(new Set());

            useEffect(() => {
                if (map.current || !mapContainer.current) return;
                map.current = new MapLibreMap({
                    container: mapContainer.current,
                    style: 'https://tiles.openfreemap.org/styles/bright',
                    center: [13.405, 52.52],
                    zoom: 10,
                    attributionControl: false
                });
                map.current.addControl(new NavigationControl(), 'top-right');

                // Add Depot Marker
                new Marker({ color: '#ef4444', scale: 1.2 })
                    .setLngLat([POTSDAM_KITCHEN.lng, POTSDAM_KITCHEN.lat])
                    .setPopup(new Popup().setText("KITCHEN: " + POTSDAM_KITCHEN.address))
                    .addTo(map.current);

                return () => { map.current?.remove(); map.current = null; };
            }, []);

            useEffect(() => {
                // Geocoding Queue
                const queue = tours.flatMap(t => t.orders.filter(o => !o.lat && !processingRef.current.has(o.id)));
                if (queue.length === 0) return;

                const process = async () => {
                    const order = queue[0];
                    if (!order) return;
                    processingRef.current.add(order.id);

                    // Use Address first, then fallback to name
                    const query = order.address ? `${order.address}, Berlin, Germany` : `${order.name}, Berlin, Germany`;
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`, {
                            headers: { 'User-Agent': 'BellaBona-IntelliRoute/1.0' }
                        });
                        const data = await res.json();
                        if (data && data.length > 0) {
                            onGeocodeUpdate(order.id, parseFloat(data[0].lat), parseFloat(data[0].lon));
                        }
                    } catch (e) {
                        // console.error("Geocode failed", e);
                    }
                    setTimeout(process, 1200); // Rate limit
                };
                process();
            }, [tours]);

            useEffect(() => {
                map.current?.resize();
            }, [height]);

            useEffect(() => {
                if (!map.current) return;
                const m = map.current;
                markersRef.current.forEach(mk => mk.remove());
                markersRef.current = [];

                const features = [];
                const bounds = new LngLatBounds();
                bounds.extend([POTSDAM_KITCHEN.lng, POTSDAM_KITCHEN.lat]); // Include depot

                tours.forEach(tour => {
                    const driver = DRIVERS.find(d => d.id === tour.driverId);
                    const color = driver ? driver.color : '#cbd5e1';

                    // Route Line: Start at Depot -> Orders
                    const coords = [[POTSDAM_KITCHEN.lng, POTSDAM_KITCHEN.lat]];

                    // Sorting by optimization (naive nearest neighbor for visual) is usually done backend
                    // but here we just respect the array order
                    tour.orders.forEach((o, idx) => {
                        if (o.lng && o.lat) {
                            coords.push([o.lng, o.lat]);
                            bounds.extend([o.lng, o.lat]);

                            // Marker
                            const el = document.createElement('div');
                            el.innerHTML = `<div style="background:${color};width:20px;height:20px;border-radius:50%;border:2px solid black;color:white;font-weight:bold;font-size:10px;display:flex;justify-content:center;align-items:center;">${idx + 1}</div>`;

                            const marker = new Marker({ element: el })
                                .setLngLat([o.lng, o.lat])
                                .setPopup(new Popup().setHTML(`<b>${o.name}</b><br>${o.address}`))
                                .addTo(m);
                            markersRef.current.push(marker);
                        }
                    });

                    if (coords.length > 1) {
                        features.push({
                            type: 'Feature',
                            properties: { color },
                            geometry: { type: 'LineString', coordinates: coords }
                        });
                    }
                });

                if (m.getSource('routes')) {
                    m.getSource('routes').setData({ type: 'FeatureCollection', features });
                } else if (m.isStyleLoaded()) {
                    m.addSource('routes', { type: 'geojson', data: { type: 'FeatureCollection', features } });
                    m.addLayer({ id: 'routes-line', type: 'line', source: 'routes', paint: { 'line-color': ['get', 'color'], 'line-width:': 4, 'line-opacity': 0.8 } });
                }

                if (!bounds.isEmpty()) m.fitBounds(bounds, { padding: 50 });
            }, [tours]);

            return <div ref={mapContainer} className="w-full h-full" />;
        };

        const GridView = ({ tours, setTours }) => {
            const draggedItem = useRef(null);
            const draggedOverItem = useRef(null);

            const handleDragStart = (e, tourIdx, orderIdx) => {
                draggedItem.current = { tourIdx, orderIdx };
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragEnter = (e, tourIdx, orderIdx) => {
                draggedOverItem.current = { tourIdx, orderIdx };
            };

            const handleDrop = (e) => {
                const source = draggedItem.current;
                const dest = draggedOverItem.current;
                if (!source || !dest) return;

                const newTours = [...tours];
                const sourceTour = newTours[source.tourIdx];
                const destTour = newTours[dest.tourIdx];

                // Remove from source
                const [movedOrder] = sourceTour.orders.splice(source.orderIdx, 1);

                // Add to dest (if dropped on an item, insert before; if assigned to column end, push)
                if (dest.orderIdx >= destTour.orders.length) {
                    destTour.orders.push(movedOrder);
                } else {
                    destTour.orders.splice(dest.orderIdx, 0, movedOrder);
                }

                setTours(newTours);
                draggedItem.current = null;
                draggedOverItem.current = null;
            };

            return (
                <div className="flex bg-slate-900 border border-slate-700 h-full overflow-x-auto rounded-lg">
                    {tours.map((tour, tIdx) => {
                        const driver = DRIVERS.find(d => d.id === tour.driverId);
                        return (
                            <div key={tour.driverId}
                                className="grid-col-driver flex-1 min-w-[160px] flex flex-col border-r border-slate-700 last:border-r-0"
                                onDragEnter={(e) => handleDragEnter(e, tIdx, tour.orders.length)}
                                onDragOver={(e) => e.preventDefault()}
                                onDrop={handleDrop}
                            >
                                <div className="p-2 border-b border-slate-700 text-center font-bold text-sm" style={{ backgroundColor: driver?.color, color: '#000' }}>
                                    {driver?.name}
                                </div>
                                <div className="flex-1 overflow-y-auto p-1 space-y-1">
                                    {tour.orders.map((order, oIdx) => (
                                        <div key={order.id}
                                            draggable
                                            onDragStart={(e) => handleDragStart(e, tIdx, oIdx)}
                                            onDragEnter={(e) => { e.stopPropagation(); handleDragEnter(e, tIdx, oIdx); }}
                                            onDragOver={(e) => e.preventDefault()}
                                            className="bg-slate-800 p-2 rounded text-xs border border-slate-600 cursor-move hover:bg-slate-700 draggable-item relative group"
                                        >
                                            <div className="font-bold truncate">{order.name}</div>
                                            <div className="text-[10px] text-slate-400 truncate">{order.address?.split(',')[0]}</div>
                                            <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 bg-black/50 rounded px-1 text-[8px]">{order.boxes}bx</div>
                                        </div>
                                    ))}
                                    {tour.orders.length === 0 && (
                                        <div className="text-center text-slate-600 text-xs italic mt-4">Empty</div>
                                    )}
                                </div>
                                <div className="p-2 border-t border-slate-700 text-[10px] text-center text-slate-400">
                                    {tour.orders.length} stops
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const RegistryView = () => {
            const [registry, setRegistry] = useState({});

            useEffect(() => {
                // Load from localStorage or mock
                const saved = localStorage.getItem('company_registry');
                if (saved) setRegistry(JSON.parse(saved));
                else {
                    // Init with some defaults
                    setRegistry({
                        "Probio 8": { address: "GoethestraÃŸe 54, 13086 Berlin" },
                        "Isi": { address: "Nonnendammallee 104, 13629 Berlin" }
                    });
                }
            }, []);

            const save = (newReg) => {
                setRegistry(newReg);
                localStorage.setItem('company_registry', JSON.stringify(newReg));
            };

            return (
                <div className="p-8 text-white">
                    <h2 className="text-2xl font-bold mb-4">Company Registry (Address Book)</h2>
                    <p className="mb-4 text-slate-400">Manage customer addresses here. These are used for geocoding and routing.</p>

                    <div className="grid grid-cols-2 gap-4">
                        {Object.entries(registry).map(([name, data]) => (
                            <div key={name} className="bg-slate-800 p-4 rounded border border-slate-600">
                                <input className="bg-transparent font-bold w-full mb-2 border-b border-slate-600 focus:outline-none" defaultValue={name} />
                                <input
                                    className="bg-slate-900 w-full p-2 rounded text-sm text-slate-300"
                                    defaultValue={data.address}
                                    onChange={(e) => {
                                        const newReg = { ...registry, [name]: { ...data, address: e.target.value } };
                                        save(newReg);
                                    }}
                                />
                            </div>
                        ))}
                    </div>
                    <button className="mt-4 bg-indigo-600 px-4 py-2 rounded font-bold" onClick={() => {
                        const name = prompt("Enter Company Name");
                        if (name) save({ ...registry, [name]: { address: "" } });
                    }}>+ Add New Company</button>
                </div>
            )
        }

        function App() {
            const [tours, setTours] = useState([]);
            const [view, setView] = useState('grid'); // 'grid' (new image style) or 'map' or 'registry'
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (window.DEFAULT_ORDERS) {
                    calculateInitialTours(window.DEFAULT_ORDERS);
                }
            }, []);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const json = JSON.parse(event.target.result);
                        // Normalize format if needed (assume list of objects)
                        let orders = Array.isArray(json) ? json : (json.orders || []);

                        // Simple normalization
                        orders = orders.map(o => ({
                            id: o.id || Math.random().toString(36),
                            name: o.name || "Unknown",
                            address: o.address || "",
                            postCode: o.postCode || "",
                            boxes: o.boxes || 1,
                            deliverySlotStart: o.deliverySlotStart || "09:00",
                            deliverySlotEnd: o.deliverySlotEnd || "12:00"
                        }));

                        calculateInitialTours(orders);
                    } catch (err) {
                        alert("Invalid JSON file");
                    }
                };
                reader.readAsText(file);
            };

            const calculateInitialTours = (orders) => {
                setLoading(true);
                // 1. Initialize empty tours
                const newTours = DRIVERS.map(d => ({ driverId: d.id, driverName: d.name, orders: [] }));

                // 2. Assign based on GOLDEN_PLAN (Fuzzy Match)
                const unassigned = [];
                const assignedIds = new Set();

                orders.forEach(order => {
                    let assigned = false;
                    for (const [driverId, keywords] of Object.entries(GOLDEN_PLAN)) {
                        // Check if order name contains any keyword
                        const match = keywords.some(k => order.name.toLowerCase().includes(k.toLowerCase()));
                        if (match) {
                            const tour = newTours.find(t => t.driverId === driverId);
                            if (tour) {
                                tour.orders.push(order);
                                assignedIds.add(order.id);
                                assigned = true;
                                break;
                            }
                        }
                    }
                    if (!assigned) unassigned.push(order);
                });

                // 3. Fallback: Distribute unassigned roughly evenly or by postcode logic
                let dIdx = 0;
                unassigned.forEach(order => {
                    // Try to find tour with capacity
                    for (let i = 0; i < newTours.length; i++) {
                        const tour = newTours[(dIdx + i) % newTours.length];
                        if (tour.orders.length < 20) { // Hard cap for fallback
                            tour.orders.push(order);
                            dIdx = (dIdx + 1) % newTours.length;
                            break;
                        }
                    }
                });

                setTours(newTours);
                setLoading(false);
            };

            const exportToCSV = () => {
                let csv = "Driver,Stop Number,Company,Address,Postal Code,Boxes\n";
                tours.forEach(t => {
                    t.orders.forEach((o, i) => {
                        csv += `${t.driverName},${i + 1},"${o.name}","${o.address}",${o.postCode},${o.boxes}\n`;
                    });
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `routing_schedule_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            return (
                <div className="h-screen flex flex-col bg-slate-950">
                    <header className="bg-slate-900 border-b border-slate-700 h-16 flex items-center px-6 justify-between shrink-0 shadow-lg z-10">
                        <div className="flex items-center gap-6">
                            <h1 className="font-black text-xl tracking-tight text-white">BELLA<span className="text-indigo-500">BONA</span> ROT</h1>
                            <nav className="flex bg-slate-800 p-1 rounded-lg">
                                <button onClick={() => setView('grid')} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${view === 'grid' ? 'bg-indigo-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>GRID PLAN</button>
                                <button onClick={() => setView('registry')} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${view === 'registry' ? 'bg-indigo-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>REGISTRY</button>
                            </nav>
                        </div>
                        <div className="flex items-center gap-3">
                            <label className="cursor-pointer bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold px-3 py-2 rounded border border-slate-600 transition-all">
                                <span>ðŸ“‚ UPLOAD JSON</span>
                                <input type="file" accept=".json" onChange={handleFileUpload} className="hidden" />
                            </label>
                            <button onClick={exportToCSV} className="bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold px-4 py-2 rounded shadow transition-all flex items-center gap-2">
                                <span>DOWNLOAD CSV</span>
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 flex overflow-hidden relative">
                        {/* Map Background (Always rendered for persistence, hidden via z-index if needed? No, user wants split or full. Let's do Split 40/60 for Grid View) */}
                        {view === 'grid' && (
                            <div className="w-full h-full flex flex-col">
                                <div className="h-[60%] border-b border-slate-700">
                                    <RouteMap tours={tours} height={600} onGeocodeUpdate={(id, lat, lng) => {
                                        setTours(prev => prev.map(t => ({
                                            ...t,
                                            orders: t.orders.map(o => o.id === id ? { ...o, lat, lng } : o)
                                        })));
                                    }} />
                                    {/* Floating Stats */}
                                    <div className="absolute top-4 left-4 bg-slate-900/90 text-white p-3 rounded border border-white/10 backdrop-blur text-xs">
                                        <div className="font-bold text-slate-400 mb-1">TOTAL ORDERS</div>
                                        <div className="text-2xl font-black">{tours.reduce((acc, t) => acc + t.orders.length, 0)}</div>
                                    </div>
                                </div>
                                <div className="h-[40%] bg-slate-900 p-2">
                                    <GridView tours={tours} setTours={setTours} />
                                </div>
                            </div>
                        )}

                        {view === 'registry' && <div className="w-full h-full overflow-y-auto"><RegistryView /></div>}
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>